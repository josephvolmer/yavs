# YAVS Multi-Provider AI System

## Overview

YAVS now supports both **Anthropic Claude** and **OpenAI GPT** models with automatic provider detection and smart fallback logic.

## Provider Detection Logic

### Priority Order:
1. **Explicit Configuration**: If `ai.provider` is set in `config.yaml`, use that provider
2. **ANTHROPIC_API_KEY**: If available, use Anthropic Claude (preferred by default)
3. **OPENAI_API_KEY**: If available and no Anthropic key, use OpenAI
4. **Error**: If no API keys found, raise an error

### Supported Models:

**Anthropic Claude:**
- `claude-sonnet-4-5-20250929` (default)
- `claude-3-5-sonnet-20241022`
- `claude-3-opus-20240229`

**OpenAI:**
- `gpt-4o` (default)
- `gpt-4-turbo`
- `gpt-3.5-turbo`

## Setup

### Option 1: Environment Variables

```bash
# Use Anthropic Claude (preferred)
export ANTHROPIC_API_KEY="sk-ant-..."

# Or use OpenAI
export OPENAI_API_KEY="sk-..."

# Or use both (Anthropic will be preferred)
export ANTHROPIC_API_KEY="sk-ant-..."
export OPENAI_API_KEY="sk-..."
```

### Option 2: .env File

Create a `.env` file in your project root:

```bash
# .env file
ANTHROPIC_API_KEY=sk-ant-api03-...
OPENAI_API_KEY=sk-...
```

Then load it before running YAVS:

```bash
# Load .env and run scan
export $(grep -v '^#' .env | xargs) && yavs scan --all
```

### Option 3: Configuration File

Edit `config.yaml`:

```yaml
ai:
  enabled: true

  # Explicit provider (null for auto-detect)
  provider: "anthropic"  # or "openai" or null

  # Explicit model (null for provider default)
  model: "claude-sonnet-4-5-20250929"  # or "gpt-4o" or null

  max_tokens: 4096
  temperature: 0.0
```

## Usage Examples

### Automatic Detection

```bash
# Auto-detects based on available API keys
export ANTHROPIC_API_KEY="sk-ant-..."
yavs scan --all
yavs summarize yavs-results.json
```

### Explicit Provider Selection

```bash
# Force use of OpenAI
export OPENAI_API_KEY="sk-..."
yavs summarize yavs-results.json --provider openai

# Force use of specific model
yavs summarize yavs-results.json --provider anthropic --model claude-3-opus-20240229
```

### Mixed Configuration

```bash
# Both keys set, but force OpenAI usage
export ANTHROPIC_API_KEY="sk-ant-..."
export OPENAI_API_KEY="sk-..."
yavs summarize yavs-results.json --provider openai --model gpt-4-turbo
```

## Provider Information Logging

YAVS clearly logs which AI provider is being used:

### During Scan:
```
[INFO] AI Provider: Anthropic Claude
[INFO] AI Model: claude-sonnet-4-5-20250929
[INFO] Generating fixes for 33 critical/high findings
✓ AI fix suggestions generated
```

### In Summary Output:
```
---
*Generated by Anthropic Claude (claude-sonnet-4-5-20250929) on 2025-11-08 12:34:56 UTC*
```

### In Triage Analysis:
```
Using Anthropic Claude (claude-sonnet-4-5-20250929)
```

## Provider Attribution in Artifacts

### JSON Output
AI-generated fixes include provider metadata:
```json
{
  "severity": "CRITICAL",
  "message": "SQL injection vulnerability",
  "ai_fix": "Use parameterized queries...",
  "ai_provider": "Anthropic Claude",
  "ai_model": "claude-sonnet-4-5-20250929"
}
```

### SARIF Output
Provider info is included in SARIF metadata properties.

### Summary Files
Attribution footer shows provider and timestamp.

## Fallback Behavior

### Smart Fallback Example:

```bash
# Config says use Anthropic, but key not available
export OPENAI_API_KEY="sk-..."

yavs scan --all
# Output:
# [WARNING] Anthropic configured but ANTHROPIC_API_KEY not found
# [INFO] Falling back to OpenAI
# [INFO] AI Provider: OpenAI
# [INFO] AI Model: gpt-4o
```

## Configuration Options Summary

| Method | Priority | Use Case |
|--------|----------|----------|
| CLI `--provider` flag | Highest | One-off runs with specific provider |
| CLI `--model` flag | Highest | Testing different models |
| `config.yaml` | Medium | Project-specific defaults |
| Auto-detection | Lowest | Simplest setup |

## Testing Your Setup

### Quick Test:

```bash
# Set your API key
export ANTHROPIC_API_KEY="your-key-here"

# Run a scan
yavs scan --all

# Check the logs - you should see:
# [INFO] AI Provider: Anthropic Claude
# [INFO] AI Model: claude-sonnet-4-5-20250929
```

### Test Both Providers:

```bash
# Test Anthropic
export ANTHROPIC_API_KEY="sk-ant-..."
yavs summarize yavs-results.json --provider anthropic

# Test OpenAI
export OPENAI_API_KEY="sk-..."
yavs summarize yavs-results.json --provider openai
```

## Troubleshooting

### Error: "No AI provider API key found"

**Solution**: Set at least one API key:
```bash
export ANTHROPIC_API_KEY="sk-ant-..."
# or
export OPENAI_API_KEY="sk-..."
```

### Provider Not Detected

**Check environment variables:**
```bash
echo $ANTHROPIC_API_KEY
echo $OPENAI_API_KEY
```

**Verify .env loading:**
```bash
export $(grep -v '^#' .env | xargs)
env | grep API_KEY
```

### Wrong Provider Being Used

**Force specific provider:**
```bash
yavs summarize results.json --provider openai
```

**Or update config.yaml:**
```yaml
ai:
  provider: "openai"  # Force OpenAI
```

## Benefits

✅ **Flexibility**: Use whichever provider you have access to
✅ **Cost Optimization**: Switch between providers based on pricing
✅ **Reliability**: Automatic fallback if one provider is unavailable
✅ **Transparency**: Clear logging of which provider is used
✅ **Traceability**: Provider attribution in all outputs

---

**Pro Tip**: If you have both API keys set, YAVS will prefer Anthropic Claude by default (as configured). You can override this in `config.yaml` or via CLI flags.

